<!DOCTYPE html>
<html>
<head>
    <title>Teste Envio Google Sheets</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #4285f4; padding-bottom: 10px; }
        button { background: #4285f4; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 16px; margin: 5px; }
        button:hover { background: #3367d6; }
        .status { padding: 15px; margin: 15px 0; border-radius: 4px; }
        .loading { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .log { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .log-entry { margin: 5px 0; padding: 5px; border-left: 3px solid #6c757d; }
        .log-entry.success { border-left-color: #28a745; }
        .log-entry.error { border-left-color: #dc3545; }
        .log-entry.info { border-left-color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Teste de Grava√ß√£o Google Sheets</h1>
        
        <div id="status" class="status loading">
            Aguardando envio dos dados...
        </div>
        
        <div>
            <button onclick="enviarDados()">üì§ Enviar Dados Agora</button>
            <button onclick="limparLogs()">üßπ Limpar Logs</button>
            <button onclick="testarMultiplos()">üîÑ Testar M√∫ltiplos Envios</button>
        </div>
        
        <div style="margin: 20px 0; padding: 15px; background: #e9ecef; border-radius: 4px;">
            <h3>üìã Dados que ser√£o enviados:</h3>
            <pre id="dataPreview" style="background: white; padding: 10px; border-radius: 3px;"></pre>
        </div>
        
        <div class="log">
            <h3>üìù Log de Eventos:</h3>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        // ‚úÖ SUBSTITUA COM SUA URL DO WEB APP
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby3CMbpfOKhO7wLknpqlKVJ4IMt2Gm5GYrI91TIMZcUOzxapT6xzZ59EwZ8y_6a4dk9cQ/exec";
        
        let logEntries = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = {
                time: timestamp,
                message: message,
                type: type
            };
            
            logEntries.unshift(entry);
            updateLogDisplay();
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            let html = '';
            
            logEntries.slice(0, 20).forEach(entry => {
                html += `<div class="log-entry ${entry.type}">
                    <strong>[${entry.time}]</strong> ${entry.message}
                </div>`;
            });
            
            logContent.innerHTML = html;
        }
        
        function updateStatus(message, type = 'loading') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function updateDataPreview() {
            const data = {
                page: window.location.href,
                referrer: document.referrer || "Direto",
                userAgent: navigator.userAgent.substring(0, 100),
                timestamp: new Date().toISOString(),
                randomId: "TEST_" + Date.now() + "_" + Math.random().toString(36).substr(2, 5)
            };
            
            document.getElementById('dataPreview').textContent = 
                JSON.stringify(data, null, 2);
        }
        
        // üéØ FUN√á√ÉO PRINCIPAL QUE DEVE FUNCIONAR
        async function enviarDados() {
            updateStatus("Coletando dados...", "loading");
            log("Iniciando coleta de dados", "info");
            
            try {
                // Coleta IP real
                let ip = "N√£o dispon√≠vel";
                try {
                    const ipResponse = await fetch('https://api.ipify.org?format=json');
                    const ipData = await ipResponse.json();
                    ip = ipData.ip;
                    log(`IP coletado: ${ip}`, "success");
                } catch (ipError) {
                    log(`N√£o foi poss√≠vel obter IP: ${ipError.message}`, "warning");
                }
                
                // Dados completos
                const dados = {
                    page: window.location.href,
                    referrer: document.referrer || "Direto",
                    userAgent: navigator.userAgent,
                    ip: ip,
                    latitude: "-23.5505",
                    longitude: "-46.6333",
                    city: "S√£o Paulo",
                    state: "SP",
                    country: "Brasil",
                    timestamp: new Date().toISOString(),
                    source: "teste_frontend",
                    testId: "TEST_" + Date.now()
                };
                
                log(`Enviando para: ${WEB_APP_URL}`, "info");
                log(`Dados: ${JSON.stringify(dados).substring(0, 150)}...`, "info");
                
                // üéØ M√âTODO QUE FUNCIONA: Fetch com tratamento adequado
                updateStatus("Enviando para Google Sheets...", "loading");
                
                const resposta = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', // üö® IMPORTANTE: Google Apps Script requer no-cors
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });
                
                // Com no-cors n√£o podemos ler a resposta, mas sabemos que foi enviada
                log("‚úÖ Requisi√ß√£o enviada com sucesso (no-cors mode)", "success");
                updateStatus("‚úÖ Dados enviados! Verificando grava√ß√£o...", "success");
                
                // Aguarda um pouco e verifica se gravou
                setTimeout(verificarSeGravou, 3000);
                
            } catch (error) {
                log(`‚ùå Erro: ${error.message}`, "error");
                updateStatus(`‚ùå Erro: ${error.message}`, "error");
            }
        }
        
        function verificarSeGravou() {
            log("üîç Verificando se dados foram gravados...", "info");
            updateStatus("üîç Verificando grava√ß√£o na planilha...", "loading");
            
            // Para verificar, precisar√≠amos de uma API de leitura
            // Por enquanto, confiamos que gravou
            log("üìä Verifique manualmente a planilha: https://docs.google.com/spreadsheets/d/10ilfKLVhvQ6xUjXdivzF7eFStyigEKv3Zyh9DvgC7ao/edit", "info");
            updateStatus("‚úÖ Processo conclu√≠do! Verifique a planilha.", "success");
        }
        
        function testarMultiplos() {
            log("üß™ Iniciando teste com m√∫ltiplos envios", "info");
            
            // Envia 3 vezes com intervalos
            for (let i = 1; i <= 3; i++) {
                setTimeout(() => {
                    log(`Envio ${i} de 3 em 3 segundos...`, "info");
                    enviarDados();
                }, i * 3000);
            }
        }
        
        function limparLogs() {
            logEntries = [];
            updateLogDisplay();
            log("Logs limpos", "info");
        }
        
        // Inicializa√ß√£o
        window.onload = function() {
            log("P√°gina carregada", "info");
            updateDataPreview();
            
            // Atualiza preview periodicamente
            setInterval(updateDataPreview, 5000);
            
            // Envia automaticamente ap√≥s 2 segundos
            setTimeout(() => {
                log("Envio autom√°tico iniciado...", "info");
                enviarDados();
            }, 2000);
        };
        
        // Log da URL
        log(`Web App URL configurada: ${WEB_APP_URL}`, "info");
        
    </script>
</body>
</html>
